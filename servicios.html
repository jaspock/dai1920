

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="es" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="es" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Servicios web &mdash; documentación de Desarrollo de Aplicaciones en Internet - </title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/estilos.css" type="text/css" />
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Búsqueda" href="search.html" />
    <link rel="next" title="5. Componentes web" href="componentes.html" />
    <link rel="prev" title="3. Programar el lado del cliente" href="cliente.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Desarrollo de Aplicaciones en Internet
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenidos:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="marcado.html">1. Lenguajes de marcado</a></li>
<li class="toctree-l1"><a class="reference internal" href="estilo.html">2. Lenguajes de estilo</a></li>
<li class="toctree-l1"><a class="reference internal" href="cliente.html">3. Programar el lado del cliente</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Servicios web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#el-protocolo-http">4.1. El protocolo HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#herramientas-para-desarrolladores">4.2. Herramientas para desarrolladores</a></li>
<li class="toctree-l2"><a class="reference internal" href="#promesas-de-javascript">4.3. Promesas de JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el-objeto-xmlhttprequest">4.4. El objeto XMLHttpRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#la-api-fetch">4.5. La API Fetch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#la-politica-del-mismo-origen">4.6. La política del mismo origen</a></li>
<li class="toctree-l2"><a class="reference internal" href="#la-arquitectura-rest">4.7. La arquitectura REST</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#envio-de-peticiones-desde-javascript">4.7.1. Envío de peticiones desde JavaScript</a></li>
<li class="toctree-l3"><a class="reference internal" href="#peticiones-cors">4.7.2. Peticiones CORS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#programacion-de-servicios-web-en-node-js">4.8. Programación de servicios web en Node.js</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interfaz-comun-de-acceso-a-bases-de-datos">4.8.1. Interfaz común de acceso a bases de datos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#async-await">4.8.2. Async/await</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web">4.9. Configuración del entorno de trabajo para ejecutar localmente una aplicación web</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#depuracion-y-prueba-de-la-aplicacion">4.9.1. Depuración y prueba de la aplicación</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modificacion-de-la-api-rest">4.10. Modificación de la API REST</a></li>
<li class="toctree-l2"><a class="reference internal" href="#despliegue-de-la-aplicacion-web-en-heroku">4.11. Despliegue de la aplicación web en Heroku</a></li>
<li class="toctree-l2"><a class="reference internal" href="#terminos-de-uso-de-las-apis-web">4.12. Términos de uso de las APIs web</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="componentes.html">5. Componentes web</a></li>
<li class="toctree-l1"><a class="reference internal" href="nube.html">6. Computación en la  nube</a></li>
<li class="toctree-l1"><a class="reference internal" href="otros.html">7. Otros elementos del desarrollo web</a></li>
<li class="toctree-l1"><a class="reference internal" href="practicas.html">8. Enunciados de las prácticas</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Desarrollo de Aplicaciones en Internet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>4. Servicios web</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/servicios.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="servicios-web">
<h1>4. Servicios web<a class="headerlink" href="#servicios-web" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Los <em>servicios web</em> proporcionan una forma estándar de interoperabilidad entre diferentes aplicaciones, posiblemente heterogéneas. En este tema, veremos cómo crear y cómo acceder a estos servicios, así como su relación con el estándar HTTP. Además, abordaremos el estudio de la arquitectura de servicios conocida como REST (por el inglés, <em>representation state transfer</em>), en la que los agentes proporcionan una interfaz con una semántica uniforme (que, básicamente, se corresponde con las operaciones para crear, recuperar, actualizar y borrar recursos), en lugar de interfaces arbitrarias o específicas de una aplicación concreta. En un primer momento, nos centraremos en el acceso a servicios web ofrecidos por terceros; posteriormente, veremos cómo definir nuestros propios servicios web.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Las habilidades que deberías adquirir con este tema incluyen las siguientes:</p>
<ul class="simple">
<li><p>Saber usar Ajax, especialmente a través de la API Fetch, como una tecnología para crear aplicaciones de una única página.</p></li>
<li><p>Saber crear y encadenar promesas en un programa de JavaScript.</p></li>
<li><p>Entender la <em>política del mismo origen</em> y cómo superarla con la técnica CORS.</p></li>
<li><p>Entender los fundamentos de la arquitectura REST.</p></li>
<li><p>Comprender los fundamentos del protocolo HTTP y la configuración cliente-servidor.</p></li>
<li><p>Diferenciar los distintos componentes de un navegador.</p></li>
<li><p>Saber implementar aplicaciones <em>mashups</em> que accedan e integren servicios web de terceros.</p></li>
</ul>
</div>
<div class="section" id="el-protocolo-http">
<h2>4.1. El protocolo HTTP<a class="headerlink" href="#el-protocolo-http" title="Enlazar permanentemente con este título">¶</a></h2>
<p>HTTP (por <em>hypertext transfer protocol</em>) es el protocolo de comunicación (a nivel de capa de aplicación) diseñado para permitir el envío de información en la <em>world wide web</em> entre distintos ordenadores. Sus primeras versiones fueron desarrolladas en la década de los noventa a partir de los trabajos de Tim Berners Lee y su equipo (los creadores de la web). Las diferentes versiones del estándar son coordinadas por el <a class="reference external" href="https://httpwg.org/">HTTP Working Group</a> de la Internet Engineering Task Force. HTTP/1.1 se publicó en 1997, HTTP/2 en 2015 y HTTP/3 en 2018, aunque tanto navegadores como servidores siguen soportando las versiones antiguas y son capaces de adaptarse para usar el mismo protocolo: por ejemplo, un navegador reciente que soporte HTTP/3 usará HTTP/2 o incluso HTTP/1.1 al comunicarse con un servidor que no haya sido actualizado en mucho tiempo. HTTP/3, a diferencia de anteriores versiones, ya no se apoya en el protocolo de transporte TCP (<em>transmission control protocol</em>), sino que usa QUIC (que no son siglas, sino un término que pretende evocar a la palabra inglesa <em>quick</em>). QUIC mejora la capacidad de multiplexación de TCP y suele mejorar la latencia y velocidad de las conexiones.</p>
<p>Los conceptos que tienes que comprender del protocolo HTTP se encuentran recogidos en <a class="reference external" href="_static/slides/050-http-slides.html">estas diapositivas</a>.</p>
</div>
<div class="section" id="herramientas-para-desarrolladores">
<h2>4.2. Herramientas para desarrolladores<a class="headerlink" href="#herramientas-para-desarrolladores" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Las herramientas para desarrolladores que incorporan los navegadores permiten estudiar los detalles de todas las conexiones establecidas por el navegador al ejecutar una aplicación web.</p>
<p>Las peticiones lanzadas desde la barra de direcciones del navegador son siempre de tipo GET. Para estudiar los otros tipos de peticiones de HTTP, necesitamos crear un formulario para peticiones de tipo POST, o, si queremos poder usar cualquier verbo, escribir código en JavaScript (usando la API Fetch que estudiáremos después) u otro lenguaje de programación. También hay herramientas como <a class="reference external" href="https://www.getpostman.com/">Postman</a>, una aplicación que permite crear cómodamente colecciones de peticiones a APIs (<em>application programming interfaces</em>). La herramienta <code class="docutils literal notranslate"><span class="pre">curl</span></code> es similar pero funciona desde la línea de órdenes.</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Familiarízate con las opciones de inspección de la actividad en red de la pestaña <span class="guilabel">Network</span> del entorno de las Chrome DevTools siguiendo la página de su documentación <a class="reference external" href="https://developers.google.com/web/tools/chrome-devtools/network">Inspect Network Activity</a> . Practica las distintas posibilidades en DevTools con peticiones GET por ahora, pero recuerda volver a esta actividad cuando estudies cómo realizar desde JavaScript peticiones con otros verbos.</p>
</div>
</div>
<div class="section" id="promesas-de-javascript">
<h2>4.3. Promesas de JavaScript<a class="headerlink" href="#promesas-de-javascript" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los objetos de tipo <code class="docutils literal notranslate"><span class="pre">Promise</span></code> (una clase definida en la API de JavaScript de los navegadores modernos) se usan para representar la finalización con éxito de una tarea (normalmente asíncrona, es decir, que no bloquea el bucle de eventos, sino que define una función de <em>callback</em> que será ejecutada más adelante) o su fracaso. En términos informales, diremos que una promesa se cumple (en caso de éxito), se incumple (en caso de fracaso) o que está pendiente (cuando aún no se ha resuelto); en inglés se usan los términos <em>fullfilled</em>, <em>rejected</em> o <em>pending</em>, respectivamente. Los objetos promesa nos serán muy útiles en tareas como la comunicación con un servidor, que veremos más adelante en este tema.</p>
<p>Veamos un primer ejemplo. El siguiente código crea un objeto de tipo promesa <code class="docutils literal notranslate"><span class="pre">p</span></code> invocando al constructor de <code class="docutils literal notranslate"><span class="pre">Promise</span></code>. Este constuctor recibe dos funciones de <em>callback</em> que son aportadas por el sistema (es decir, no son definidas por el programador); estas dos funciones (<code class="docutils literal notranslate"><span class="pre">resolve</span></code> y <code class="docutils literal notranslate"><span class="pre">reject</span></code> en el código de abajo) serán invocadas en los lugares de nuestro código en los que determinemos que la tarea se ha desarrollado con éxito (en el caso del primer parámetro) o ha fracasado (función pasada como segundo parámetro). En este caso, vamos a suponer que nuestra promesa ejecuta una tarea asíncrona muy sencilla: esperar un segundo y generar un número aleatorio entre 0 y 1; la tarea se considera un éxito si el número es menor de 0,5. En lenguaje de la calle, sería como decir «te prometo que voy a generar (asíncronamente) un número aleatorio y que será menor que 0,5»; como cualquier promesa, en cualquier caso, esta puede cumpirse o no.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre>  let p= new Promise(function(resolve,reject) {
    console.log(&#39;Entrando en el constructor de la promesa&#39;);
    setTimeout( function() {
      const r= Math.random();
      if (r&lt;0.5) {
        resolve(&#39;la cosa fue bien&#39;);
      }
      else {
        reject(&#39;algo salió mal&#39;);
      }
    }, 1000);
  });

  p.then(function(mensaje) {
      console.log(`Promesa cumplida: ${mensaje}`);
    }, function(mensaje) {
      console.log(`Promesa incumplida: ${mensaje}`);
    }
  );
</pre></div>
</td></tr></table></div>
<p>Las funciones <code class="docutils literal notranslate"><span class="pre">resolve</span></code> y <code class="docutils literal notranslate"><span class="pre">reject</span></code> reciben un único argumento que usaremos para dar información adicional relacionada con el éxito o fracaso de la tarea asíncrona; en este caso, es una simple cadena con un mensaje, pero puede ser un objeto que incluya un conjunto de atributos. Nada más invocar al contructor de <code class="docutils literal notranslate"><span class="pre">Promise</span></code> se establece el estado de la promesa a <em>pendiente</em> y se ejecuta el código de la función pasada como parámetro al constructor. Este código normalmente definirá una operación asíncrona (como realizar una petición a un servidor) y terminará llamando a <code class="docutils literal notranslate"><span class="pre">resolve</span></code> o <code class="docutils literal notranslate"><span class="pre">reject</span></code>; estas funciones (recordemos que son creadas por el sistema y no pertenecen a nuestro código) cambian el estado de la promesa a <em>cumplida</em> o <em>incumplida</em> y llaman a las funciones que el programador haya definido para manejar ambas situaciones.</p>
<p>El vínculo entre las funciones del sistema <code class="docutils literal notranslate"><span class="pre">resolve</span></code> y <code class="docutils literal notranslate"><span class="pre">reject</span></code> y nuestro código se establece llamando al método <code class="docutils literal notranslate"><span class="pre">then</span></code> sobre el objeto de tipo promesa. Al método <code class="docutils literal notranslate"><span class="pre">then</span></code> se le pasan dos funciones: la primera se vincula a <code class="docutils literal notranslate"><span class="pre">resolve</span></code> y la segunda a <code class="docutils literal notranslate"><span class="pre">reject</span></code>. Estas funciones pueden tener un parámetro que será el mismo que el usado como argumento en las llamadas a <code class="docutils literal notranslate"><span class="pre">resolve</span></code> y <code class="docutils literal notranslate"><span class="pre">reject</span></code> del constructor de <code class="docutils literal notranslate"><span class="pre">Promise</span></code>.</p>
<p>Finalmente, observa en el código anterior cómo hemos usado <em>cadenas con plantillas</em> (<em>template strings</em>) para imprimir los mensajes por consola. Las cadenas con plantillas de JavaScript usan comillas invertidas en lugar de rectas, pueden contener variables embebidas como en el ejemplo, y pueden también ocupar más de una línea.</p>
<div class="figure align-default" id="id1">
<a class="reference external image-reference" href="https://www.c-sharpcorner.com/blogs/overview-of-promises-in-javascript"><img alt="diagrama de los elementos implicados en una promesa" src="https://csharpcorner-mindcrackerinc.netdna-ssl.com/UploadFile/BlogImages/01262017214716PM/Screen%20Shot%202017-01-26%20at%208.28.19%20pm.png" /></a>
<p class="caption"><span class="caption-text">Diagrama de los elementos de una promesa por Sumant Mishra</span><a class="headerlink" href="#id1" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>El código anterior es equivalente al siguiente en el que en lugar de pasar dos funciones a <code class="docutils literal notranslate"><span class="pre">then</span></code> se define la función asociada al incumplimiento de la promesa en un método <code class="docutils literal notranslate"><span class="pre">catch</span></code>:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre>&lt;div id=&quot;promesas830&quot;&gt;
  let p= new Promise(function(resolve,reject) {
    setTimeout( function() {
      const r= Math.random();
      if (r&lt;0.5) {
        resolve(&#39;la cosa fue bien&#39;);
      }
      else {
        reject(&#39;algo salió mal&#39;);
      }
    }, 1000);
  });

  p.then(function(mensaje) {
      console.log(`Promesa cumplida: ${mensaje}`);
    })
    .catch(function(mensaje) {
      console.log(`Promesa incumplida: ${mensaje}`);
    });
</pre></div>
</td></tr></table></div>
<p>Además, si encapsulamos el código de creación de la promesa en una función, usamos funciones flecha y gestionamos el error mediante una excepción (clase <code class="docutils literal notranslate"><span class="pre">Error</span></code>), el código anterior se convierte en:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre>function aleatorio() {
  return new Promise( (resolve,reject) =&gt; {
    setTimeout( () =&gt; {
      const r= Math.random();
      if (r&lt;0.5) {
        resolve(&#39;la cosa fue bien&#39;);
      }
      else {
        reject(Error(&#39;algo salió mal&#39;));
      }
    }, 1000);
});

aleatorio()
  .then( (mensaje) =&gt; {console.log(`Promesa cumplida: ${mensaje}`);})
  .catch( (mensaje) =&gt; {console.log(`Promesa incumplida: ${error.message}`);});
&lt;/div&gt;
</pre></div>
</td></tr></table></div>
<p>Las promesas pueden concatenarse simplemente haciendo que la función asociada al cumplimiento de la promesa (la indicada en la llamada al método <code class="docutils literal notranslate"><span class="pre">then</span></code>) devuelva a su vez una promesa:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre>  aleatorio().then( (mensaje) =&gt; {
    console.log(`Primera promesa cumplida: ${mensaje}`);
    return aleatorio2(0.8);
  })
  .then( (mensaje) =&gt; {
    console.log(`Segunda promesa cumplida: ${mensaje}`);
  })
  .catch( (error) =&gt; {
    console.log(`Una de las promesas fue incumplida: ${error.message}`);
  }
  );

  function aleatorio() {
    return new Promise( (resolve,reject) =&gt; {
      setTimeout( () =&gt; {
        const r= Math.random();
        if (r&lt;0.5) {
          resolve(&#39;la cosa fue bien&#39;);
          }
        else {
          reject(Error(&#39;algo salió mal&#39;));
        }
      }, 1000);
    });
  }

  function aleatorio2(delta) {
    return new Promise( (resolve,reject) =&gt; {
      setTimeout( () =&gt; {
        const r= Math.random();
        if (r&lt;delta) {
          resolve(&#39;me encanta que los planes salgan bien&#39;);
        }
        else {
          reject(Error(&#39;peor imposible&#39;));
        }
      }, 1000);
    });
  }
</pre></div>
</td></tr></table></div>
<p>En este caso, la segunda promesa establece una clausura con el parámetro de la función que indica el umbral para que la promesa se cumpla. Si encapsulamos todos los bloques en funciones, el código principal queda muy compacto y legible:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre>aleatorio()
  .then(primerMensaje)
  .then(segundoMensaje)
  .catch(mensajeError);

function primerMensaje (mensaje) {
  console.log(`Primera promesa cumplida: ${mensaje}`);
  return aleatorio2(0.8);
}

function segundoMensaje (mensaje) {
  console.log(`Segunda promesa cumplida: ${mensaje}`);
}

function mensajeError (error) {
  console.log(`Una de las promesas fue incumplida: ${error.message}`);
}

function aleatorio() {
  return new Promise( (resolve,reject) =&gt; {
    setTimeout( () =&gt; {
      const r= Math.random();
      if (r&lt;0.5) {
        resolve(&#39;la cosa fue bien&#39;);
      }
      else {
        reject(Error(&#39;algo salió mal&#39;));
      }
    }, 1000);
  });
}

function aleatorio2(delta) {
  return new Promise( (resolve,reject) =&gt; {
    setTimeout( () =&gt; {
      const r= Math.random();
      if (r&lt;delta) {
        resolve(&#39;me encanta que los planes salgan bien&#39;);
      }
      else {
        reject(Error(&#39;peor imposible&#39;));
      }
    }, 1000);
  });
}
</pre></div>
</td></tr></table></div>
<p>Uno de los motivos de la introducción de las promesas en JavaScript fue precisamente el de simplificar la escritura de código en los frecuentes casos que los que un evento asíncrono dispara a su terminación otro evento asíncrono que dispara a su vez un nuevo evento asíncrono, etc. El código sin promesas termina teniendo una cantidad tal de ámbitos que su escritura y su lectura se hacen muy dificultosas:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre>  function aleatorio() {
      setTimeout( () =&gt; {
          const r= Math.random();
          if (r&lt;0.5) {
            let mensaje= &#39;la cosa fue bien&#39;;
            alert(`Primera promesa cumplida: ${mensaje}`);
            let delta= 0.8;
            setTimeout( () =&gt; {
              const r= Math.random();
              if (r&lt;delta) {
                let mensaje= &#39;me encanta que los planes salgan bien&#39;;
                alert(`Segunda promesa cumplida: ${mensaje}`);
              }
              else {
                let error= Error(&#39;peor imposible&#39;);
                alert(`Una de las promesas fue incumplida: ${error.message}`);
              }
            }, 1000);
          }
          else {
            let error= Error(&#39;algo salió mal&#39;);
            alert(`Una de las promesas fue incumplida: ${error.message}`);
          }
    }, 1000);
  }

  aleatorio();
</pre></div>
</td></tr></table></div>
<p>Finalmente, JavaScript ha incluido más recientemente las <a class="reference external" href="https://developers.google.com/web/fundamentals/primers/async-functions">funciones asíncronas</a> que permiten simplificar aún más las cadenas de promesas al utilizar la misma notación secuencial empleada en segmentos síncronos de código con los bloques de código que contienen llamadas asíncronas. No los veremos, sin embargo, este curso.</p>
<div class="admonition-problema-contador-problema admonition">
<p class="admonition-title"><span class="problema-contador">Problema</span></p>
<p>Sabiendo que no hay ningún error en el siguiente código, indica la salida que emite por consola el siguiente bloque de JavaScript:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span class="nx">p1</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">x</span><span class="p">);</span> <span class="k">return</span> <span class="nx">p2</span><span class="p">(</span><span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">x</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="nx">x</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span> <span class="p">}</span> <span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">a</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span> <span class="nx">x</span><span class="p">.</span><span class="nx">a</span><span class="o">++</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span> <span class="p">)</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">a</span><span class="o">*</span><span class="nx">x</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="p">);</span>

<span class="kd">function</span> <span class="nx">p1</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">p2</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="o">:</span><span class="nx">a</span><span class="o">*</span><span class="nx">b</span><span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition-problema-contador-problema admonition">
<p class="admonition-title"><span class="problema-contador">Problema</span></p>
<p>Sabiendo que no hay ningún error en el siguiente código, indica con qué valor hay que sustituir las expresiones <code class="docutils literal notranslate"><span class="pre">&#64;1</span></code> y <code class="docutils literal notranslate"><span class="pre">&#64;2</span></code> en el siguiente código para que la salida emitida por consola sea 5:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">new</span> <span class="n">Promise</span><span class="p">(</span> <span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="n">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">resolve</span><span class="p">(</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span> <span class="p">)</span> <span class="p">)</span>
<span class="o">.</span><span class="n">then</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">new</span> <span class="n">Promise</span> <span class="p">(</span>
    <span class="n">function</span> <span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="n">reject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">+</span><span class="mi">5</span><span class="o">===</span><span class="nd">@1</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="o">===</span><span class="nd">@2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resolve</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">reject</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">b</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">})</span>
<span class="o">.</span><span class="n">then</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span>
<span class="o">.</span><span class="n">catch</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="el-objeto-xmlhttprequest">
<h2>4.4. El objeto XMLHttpRequest<a class="headerlink" href="#el-objeto-xmlhttprequest" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En los primeros años de la web, la mayoría de las aplicaciones web seguían el siguiente patrón de comportamiento al realizar, por ejemplo, una búsqueda de un determinado elemento en una base de datos: el usuario rellenaba los valores correspondientes para buscar el elemento en un formulario y pulsaba el botón de enviar; en ese momento, el navegador realizaba una petición al servidor y borraba la página web actual; el servidor realizaba la búsqueda en la base de datos y devolvía entonces una página web completa que el navegador mostraba en sustitución de la anterior. Además de generar una experiencia incómoda al usuario si se compara con una aplicación tradicional de escritorio (el usuario ha de esperar a que se cargue de nuevo toda la página para seguir interactuando con la aplicación), este procedimiento es muy ineficiente cuando la página web tiene mucho contenido que apenas cambia, y que, sin embargo, es enviado continuamente por el servidor.</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Prepárate para este tema, leyendo en primer lugar los capítulos sobre <a class="reference external" href="https://info340.github.io/client-side-development.html">desarrollo en el lado del cliente</a> y <a class="reference external" href="https://info340.github.io/ajax.html">peticiones Ajax</a> del libro «Client-Side Web Development».</p>
</div>
<p>A partir de finales de los noventa y especialmente en los primeros años del siglo XXI, los desarrolladores comienzan a explotar el uso de funcionalidades de los navegadores que permiten realizar peticiones a un servidor sin tener que recargar la página completa. A estas técnicas se les denomina Ajax por razones históricas: el término lo acuñó un desarrollador en 2005 como acrónimo de <em>Asynchronous JavaScript and XML</em>. Con Ajax, los datos devueltos por el servidor se usan para generar dinámicamente HTML que es insertado convenientemente en el árbol DOM, conformando lo que se conoce como <em>aplicaciones de una solo página</em> (<em>single-page applications</em>). La más usada de las técnicas Ajax se basaba en el objeto <code class="docutils literal notranslate"><span class="pre">XMLHttpRequest</span></code> (para abreviar se suele llamar <em>XHR</em>) que permite, como se ha comentado, solicitar (normalmente de forma asícrona) una serie de datos al servidor desde JavaScript en lugar de una página completa que reemplazará a la actual. Estos datos serán, entonces, procesados por una función definida por el programador.</p>
<p>El siguiente es un ejemplo típico de uso:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// Los datos del servidor se insertarán en el elemento con id &#39;results&#39;:</span>
<span class="kd">var</span> <span class="nx">resultado</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#results&quot;</span><span class="p">);</span>

<span class="c1">// Borra el contenido previo del elemento:</span>
<span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

<span class="c1">// Crea el objeto XHR:</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">url</span><span class="o">=</span> <span class="s2">&quot;https://ghibliapi.herokuapp.com/films/&quot;</span><span class="p">;</span>
<span class="c1">// Identifica el verbo, la URL y que la petición será asíncrona:</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// La función asignada a onreadystatechange es invocada varias veces por</span>
<span class="c1">// el navegador durante el transcurso de las diferentes fases de comunicación</span>
<span class="c1">// con el servidor (conexión establecida, petición recibida, petición en proceso,</span>
<span class="c1">// petición finalizada); la fase de la llamada actual se almacena en readyState;</span>
<span class="c1">// normalmente, nos interesa la llamada en la que readyState tiene el valor 4,</span>
<span class="c1">// que se hace en el momento en el que el servidor ha devuelto todos los</span>
<span class="c1">// datos:</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Código de estado de HTTP:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Hubo un error (&quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="s2">&quot;)!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// JSON.parse analiza la cadena pasada como argumento y la convierte</span>
      <span class="c1">// a un objeto de JavaScript; la respuesta de esta petición es un array</span>
      <span class="c1">// que se almacena en r:</span>
      <span class="kd">var</span> <span class="nx">r</span><span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>

      <span class="c1">// Los datos devueltos son de la forma [ {&quot;id&quot;: &quot;0440483e&quot;, &quot;title&quot;: &quot;Princess</span>
      <span class="c1">// Mononoke&quot;, &quot;description&quot;: &quot;Ashitaka, a prince of the disappearing Ainu tribe...&quot;,</span>
      <span class="c1">// &quot;director&quot;: ..., &quot;producer&quot;: ...},   {&quot;id&quot;: dc2e6bd1&quot;, &quot;title&quot;: &quot;Spirited Away&quot;,</span>
      <span class="c1">// &quot;description&quot;: &quot;Spirited Away is an Oscar winning Japanese animated film about</span>
      <span class="c1">// a ten year old girl who wanders away from her parents...&quot;, &quot;director&quot;: &quot;Hayao</span>
      <span class="c1">// Miyazaki&quot;, ...},  {...},  {...} ]</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">+=</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="c1">// Realiza la petición:</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Este código accede a modo de ejemplo a una <a class="reference external" href="https://ghibliapi.herokuapp.com/">API web</a> sobre las películas del estudio Ghibli. Los datos devueltos por esta API web (y por muchas otras) están codificados en una notación independiente del lenguaje denominada JSON (por <em>JavaScript Object Notation</em>), que es muy parecida a la que se usa en JavaScript para definir literalmente un objeto, pero con algunas diferencias: principalmente, que los atributos van siempre entrecomillados, que no pueden usarse comillas simples y que no pueden incluirse valores de algunos tipos especiales de JavaScript como, por ejemplo, funciones. Como ves en el código anterior, la función <code class="docutils literal notranslate"><span class="pre">JSON.parse</span></code> permite convertir una cadena en formato a JSON a objeto de JavaScript; para lo opuesto, puede usarse la función <code class="docutils literal notranslate"><span class="pre">JSON.stringify</span></code>. En APIs web más antiguas se usaba el formato XML en lugar de JSON.</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Prueba el código del ejemplo anterior (por ejemplo, en una web como JSFiddle) para comprender su funcionamiento y estudia todo el tráfico de red mediante las Chrome DevTools. Asegúrate de crear un elemento con id <code class="docutils literal notranslate"><span class="pre">results</span></code> en el documento HTML. Escribe código para probar también otras APIs públicas, como la de <a class="reference external" href="https://github.com/martincarrera/clash-royale-api">información del juego Clash Royale</a>.</p>
</div>
</div>
<div class="section" id="la-api-fetch">
<h2>4.5. La API Fetch<a class="headerlink" href="#la-api-fetch" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En los últimos años, sin embargo, los navegadores han comenzado a implementar la API Fetch (desarrollada por el WHATWG, Web Hypertext Application Technology Working Group, que también supervisa la evolución de otros estándares como HTML o la API DOM), que es una forma más potente, extensible y flexible de acceder a recursos externos. Usando esta API en lugar de XHR, el código mostrado anteriormente quedaría como sigue:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">resultado</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#results&quot;</span><span class="p">);</span>
<span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://ghibliapi.herokuapp.com/films/&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">responseAsObject</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">responseAsObject</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">+=</span> <span class="nx">responseAsObject</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Ha habido un problema: &#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>No te costará entender este código si repasas lo estudiado en una sección anterior sobre las promesas en JavaScript y te decimos que la función <code class="docutils literal notranslate"><span class="pre">fetch</span></code> devuelve una promesa que se cumple cuando el servidor devuelve un resultado (aunque la respuesta incluya un código de error de HTTP) y se incumple cuando por cualquier motivo no es posible establecer la comunicación con el servidor. También debería ser fácil deducir que la función <code class="docutils literal notranslate"><span class="pre">json</span></code> devuelve otra promesa que se cumple si el cuerpo de la respuesta del servidor (que se pasa por <code class="docutils literal notranslate"><span class="pre">fetch</span></code> a la función <code class="docutils literal notranslate"><span class="pre">resolve</span></code> y de ahí a la función del primer método <code class="docutils literal notranslate"><span class="pre">then</span></code>) es una cadena en formato JSON que se puede convertir sin errores (usando <code class="docutils literal notranslate"><span class="pre">JSON.parse()</span></code>) en un objeto de JavaScript.</p>
<p>También debería ser fácil de entender el siguiente código, que añade un paso intermedio al procesamiento de la respuesta del servidor que convierte los títulos de películas almacenados en el objeto de JavaScript a minúsculas. Para ello, define una función que devuelve una promesa que no se cumple únicamente en el caso de que la cadena del atributo <code class="docutils literal notranslate"><span class="pre">title</span></code> sea vacía.</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">minusculas</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">promise</span><span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">=</span> <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;String cannot be empty!&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">resultado</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#results&quot;</span><span class="p">);</span>
<span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://ghibliapi.herokuapp.com/films/&#39;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>  <span class="c1">// llama a JSON.parse()</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">minusculas</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">responseAsObject</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">responseAsObject</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">+=</span> <span class="nx">responseAsObject</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Ha habido un problema: \n&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Las peticiones realizadas por <code class="docutils literal notranslate"><span class="pre">fetch</span></code> son, por defecto, de tipo GET. Más adelante, veremos como realizar peticiones con otros verbos, añadir información en JSON o dar valor a ciertas cabeceras de HTTP.</p>
<div class="admonition-problema-contador-problema admonition">
<p class="admonition-title"><span class="problema-contador">Problema</span></p>
<p>Teníamos un fragmento correcto de código en JavaScript que realizaba una petición asíncrona a <code class="docutils literal notranslate"><span class="pre">http://example.com/movies.json/birdbox</span></code> y mostraba por consola el valor del atributo <code class="docutils literal notranslate"><span class="pre">title</span></code> de los datos en JSON devueltos por el servidor. Lamentablemente, las líneas de nuestro programa se han desordenado y, además, mezclado con líneas de otros programas. Indica la secuencia de líneas, de entre las siguientes, que permiten reconstruir el programa original. Una posible respuesta (incorrecta) sería <em>03,09,04</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="mi">01</span>    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">02</span>    <span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="mi">03</span>    <span class="p">})</span>
<span class="mi">04</span>    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
<span class="mi">05</span>    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="mi">06</span>    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">title</span><span class="p">);</span>
<span class="mi">07</span>    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">08</span>    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">);</span>
<span class="mi">09</span>    <span class="p">});</span>
<span class="mi">10</span>    <span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://example.com/movies.json/birdbox&#39;</span><span class="p">)</span>
<span class="mi">11</span>    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
<span class="mi">12</span>    <span class="n">fetch</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="s">&#39;http://example.com/movies.json/birdbox&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="admonition-problema-contador-problema admonition">
<p class="admonition-title"><span class="problema-contador">Problema</span></p>
<p>Indica los tres errores de formato que hay en la representación en JSON del siguiente dato y cómo los solucionarías con la menor cantidad de modificaciones.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Duke&quot;</span><span class="p">,</span>
  <span class="n">age</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
  <span class="s">&quot;streetAddress&quot;</span><span class="p">:</span> <span class="s">&quot;100 Internet Dr&quot;</span><span class="p">,</span>
  <span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;New York&quot;</span><span class="p">,</span>
  <span class="s">&quot;married&quot;</span><span class="p">:</span> <span class="n">true</span>
  <span class="s">&quot;sex&quot;</span><span class="p">:</span> <span class="n">male</span><span class="p">,</span>
  <span class="s">&quot;companies&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s">&quot;universities&quot;</span><span class="p">:</span> <span class="p">[{}</span>  <span class="p">],</span>
  <span class="s">&quot;phoneNumbers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="s">&quot;Mobile&quot;</span><span class="p">:</span> <span class="s">&quot;1111111111&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Mobile&quot;</span><span class="p">:</span> <span class="mi">2222222222</span> <span class="p">},</span>
    <span class="mi">33333</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="la-politica-del-mismo-origen">
<h2>4.6. La política del mismo origen<a class="headerlink" href="#la-politica-del-mismo-origen" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Todos los navegadores implementan una restricción conocida como <em>política del mismo origen</em> (en inglés, <em>same-origin policy</em>), un concepto de seguridad existente desde la época de Netscape 2.0 para peticiones basadas en XHR o en la API Fetch. Esta política impide por defecto que desde un script bajado de un determinado servidor se realicen peticiones a servicios web disponibles en un servidor con un dominio diferente. Permitir este tipo de accesos abre la puerta a toda una serie de potenciales problemas: por ejemplo, <em>MaliciousSite.com</em> usa los servicios web de la web de <em>MyBank.com</em> (en la que el usuario tiene sesión abierta en otra pestaña del navegador) para obtener información confidencial; los servicios web de <em>MyBank.com</em> devuelven la información solicitada porque el usuario está autenticado y la <em>cookie</em> de autenticación es enviada por el navegador junto con la petición; el script con origen <em>MaliciousSite.com</em> puede ahora compartir esta información con otros servidores.</p>
<p>Si la política del mismo origen no pudiera evitarse, muchas aplicaciones web que usan servicios web <em>de terceros</em> desde el cliente no podrían existir o deberían implementar un proxy a dichos servicios web en su propio servidor. Por ello, los navegadores permiten bajo determinadas condiciones que estos accesos puedan realizarse. En particular, la técnica estándar CORS (<em>cross-origin resource sharing</em>) utiliza la cabecera <em>Origin</em> (que es añadida por el navegador y no puede modificarse desde JavaScript) en la petición para informar al servidor del origen del código que está haciendo la solicitud. El servidor puede autorizar o denegar entonces el acceso añadiendo a la respuesta un valor adecuado en la cabecera <em>Access-Control-Allow-Origin</em>; si el valor de esta última cabecera en la respuesta coincide con el valor de <em>Origin</em> en la petición o si toma un valor como <cite>*</cite>, entonces el navegador autoriza el acceso. En peticiones que pueden modificar datos en el servidor (como las de tipo PUT o DELETE), el navegador realiza una comunicación previa con el servidor (usando el verbo <em>OPTIONS</em>) para realizar algunas comprobaciones <em>pre-vuelo</em> (<em>pre-flight</em>) usando las cabeceras ya mencionadas.</p>
<p>Aunque no es fácil engañar al servidor modificando el valor enviado por el navegador en la cabecera <em>Origin</em>, debe tenerse en cuenta que el propósito de CORS no es el de hacer un sitio web más seguro; si el servidor devuelve datos privados, es necesario usar <em>cookies</em> o <em>tokens</em>, por ejemplo.</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>En una actividad anterior tienes un ejemplo de acceso a un servicio (el de información sobre el estudio Ghibli) que usa CORS. Estúdialo con ayuda de las herramientas para desarrolladores del navegador comprobando las cabeceras. Estudia también una petición vía Fetch a un servidor que no soporte CORS, como el de <a class="reference external" href="https://date.nager.at/Home/Api">esta API</a> de días <a class="reference external" href="http://date.nager.at/api/v1/get/ES/2020">festivos</a>.</p>
</div>
<p>Finalmente, es importante resaltar que estas restricciones afectan a los servicios web a los que se intenta acceder desde un navegador. Una aplicación de escritorio o un programa ejecutándose en un servidor no tienen estas restricciones.</p>
</div>
<div class="section" id="la-arquitectura-rest">
<h2>4.7. La arquitectura REST<a class="headerlink" href="#la-arquitectura-rest" title="Enlazar permanentemente con este título">¶</a></h2>
<p>REST es una arquitectura para implementar servicios web sobre el protocolo HTTP que es usada actualmente por la gran mayoría de APIs web. Bajo REST los recursos se representan mediante URLs y las acciones a realizar con ellos se indican mediante los correspondientes verbos de HTTP (principalmente, GET, POST, PUT y DELETE).</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>En esta actividad vamos a explorar una API REST <em>de jueguete</em> para gestionar carritos de la compra. Para acceder a la API vamos a usar <code class="docutils literal notranslate"><span class="pre">curl</span></code>, un programa que permite realizar peticiones HTTP desde la línea de órdenes y observar la respuesta devuelta por el servidor. Ve probando en tu ordenador todos los pasos siguientes.</p>
</div>
<p>En primer lugar, vamos a asignar a una variable de entorno el URL base de la API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">endpoint</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">whispering</span><span class="o">-</span><span class="n">plains</span><span class="o">-</span><span class="mf">89598.</span><span class="n">herokuapp</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">carrito</span><span class="o">/</span><span class="n">v1</span>
</pre></div>
</div>
<p><em>Nota:</em> la sintaxis que seguiremos aquí para manejar variables de entorno es la usada en sistemas basados en Unix. Para otros sistemas operativos, la sintaxis podría ser ligeramente diferente.</p>
<p>El primer paso con la API del carrito suele ser obtener un identificador de carrito válido, lo que haremos con el verbo POST:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request POST --header &#39;content-type:application/json&#39; -v $endpoint/creacarrito
</pre></div>
</div>
<p>La opción <code class="docutils literal notranslate"><span class="pre">--request</span></code> indica el verbo a usar y la opción <code class="docutils literal notranslate"><span class="pre">--header</span></code> sirve para identificar las cabeceras de la petición; en este caso, usamos la cabecera <code class="docutils literal notranslate"><span class="pre">content-type</span></code> que se usa para indicar al servidor en qué formato (JSON, en este caso) queremos recibir los datos de la respuesta; el servidor podría ignorar nuestra solicitud si no soportara dicho formato, lo que no es el caso. Finalmente, la opción <code class="docutils literal notranslate"><span class="pre">--v</span></code> hace que <code class="docutils literal notranslate"><span class="pre">curl</span></code> muestre información más detallada sobre la petición y la respuesta. La petición anterior nos devolverá en formato JSON el nombre del carrito recién creado en el atributo <code class="docutils literal notranslate"><span class="pre">result.nombre</span></code>. Asigna dicho valor (por ejemplo, <code class="docutils literal notranslate"><span class="pre">fada6</span></code>) a la variable de entorno <code class="docutils literal notranslate"><span class="pre">carrito</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">carrito</span><span class="o">=</span><span class="n">fada6</span>
</pre></div>
</div>
<p>Ten en cuenta que si ningún cliente ha realizado una petición a la API en los últimos minutos, la primera respuesta puede tardar unos segundos en producirse. Vamos a añadir ahora un item al carrito. Para ello usamos el verbo POST sobre la ruta <code class="docutils literal notranslate"><span class="pre">$endpoint/$carrito/productos</span></code>; los datos del nuevo item los pasaremos en JSON dentro del cuerpo (<em>payload</em>) del mensaje, al que damos valor con la opción <code class="docutils literal notranslate"><span class="pre">--data</span></code> de <code class="docutils literal notranslate"><span class="pre">curl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request POST --data &#39;{&quot;item&quot;:&quot;queso&quot;,&quot;cantidad&quot;:1}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>El servidor nos devuelve un resultado en JSON con dos atributos, <code class="docutils literal notranslate"><span class="pre">result</span></code> y <code class="docutils literal notranslate"><span class="pre">error</span></code>; el primero contiene información adicional si la petición pudo satisfacerse (el código de estado es 200 en ese caso); el atributo <code class="docutils literal notranslate"><span class="pre">error</span></code> contiene mas información sobre el error en caso de haberse producido (el código de estado es 404 en ese caso); si no procede dar valor a <code class="docutils literal notranslate"><span class="pre">result</span></code> o <code class="docutils literal notranslate"><span class="pre">error</span></code>, estos atributos tomarán el valor <code class="docutils literal notranslate"><span class="pre">null</span></code>. Vamos a añadir otro item al carrito:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request POST --data &#39;{&quot;item&quot;:&quot;leche&quot;,&quot;cantidad&quot;:4}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Para obtener la composición de un carrito, usaremos el verbo GET:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request GET --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Obtendremos una respuesta como la siguiente:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;nombre&quot;</span><span class="p">:</span><span class="s">&quot;fada6&quot;</span><span class="p">,</span>
    <span class="s">&quot;productos&quot;</span><span class="p">:[{</span><span class="s">&quot;item&quot;</span><span class="p">:</span><span class="s">&quot;queso&quot;</span><span class="p">,</span><span class="s">&quot;cantidad&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
                  <span class="p">{</span><span class="s">&quot;item&quot;</span><span class="p">:</span><span class="s">&quot;leche&quot;</span><span class="p">,</span><span class="s">&quot;cantidad&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">}]</span>
  <span class="p">},</span>
  <span class="s">&quot;error&quot;</span><span class="p">:</span><span class="n">null</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Para modificar la cantidad de un item ya existente en el carrito, usaremos la acción PUT e indicaremos la nueva cantidad en JSON en el bloque de datos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request PUT --data &#39;{&quot;cantidad&quot;:2}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Comprobamos que el carrito ha sido actualizado con la nueva cantidad:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request GET --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Finalmente, podemos borrar un producto con la acción DELETE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request DELETE --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
curl --request DELETE --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Con la segunda petición, el servidor devolverá un error indicando que el producto no existe.</p>
<p>Si quisiéramos añadir un nuevo item cuyo nombre lleve algún carácter especial (por ejemplo, la vocal con tilde de <em>jamón</em>), lo podemos hacer como en los casos anteriores:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request POST --data &#39;{&quot;item&quot;:&quot;jamón&quot;,&quot;cantidad&quot;:2}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Pero a la hora de hacer una petición en la que el nombre del item forme parte del URL (y no del bloque de datos), es necesario convertir los caracteres especiales a aquellos que puedan formar parte de un URL a través de lo que se conoce como <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Glossary/percent-encoding">codificación por ciento</a> (<em>percent-encoding</em>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>curl --request PUT --data &#39;{&quot;cantidad&quot;:5}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/jam%C3%B3n
</pre></div>
</div>
<p>En JavaScript tenemos funciones como <code class="docutils literal notranslate"><span class="pre">decodeURIComponent</span></code> y <code class="docutils literal notranslate"><span class="pre">encodeURIComponent</span></code> que se encargan del trabajo de conversión. Para codificar un símbolo para el programa <code class="docutils literal notranslate"><span class="pre">curl</span></code> que se ejecuta en la línea de órdenes podemos usar <a class="reference external" href="https://meyerweb.com/eric/tools/dencoder/">herramientas en línea</a>.</p>
<div class="section" id="envio-de-peticiones-desde-javascript">
<h3>4.7.1. Envío de peticiones desde JavaScript<a class="headerlink" href="#envio-de-peticiones-desde-javascript" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Ahora vamos a ver cómo interactuar con la API del carrito desde JavaScript (en concreto, usando la API Fetch que hemos estudiado antes) por medio de una aplicación web de <a class="reference external" href="https://whispering-plains-89598.herokuapp.com/carrito.html">gestión de carritos de la compra</a>. Abre las DevTools de Google Chrome y estudia cada una de las peticiones Fetch realizadas por la aplicación. El código de este cliente de la API es el siguiente:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271</pre></div></td><td class="code"><div class="highlight"><pre>&lt;!doctype html&gt;
&lt;!-- Ejemplos de uso de la API web del carrito con la API Fetch del navegador --&gt;
&lt;html lang=&quot;es&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;link href=&quot;style.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
  &lt;title&gt;Carrito&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

  &lt;h1&gt;Gestión de carritos de la compra&lt;/h1&gt;
  &lt;!-- Formularios: --&gt;
  &lt;form id=&quot;f0&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Usar un carrito ya existente&lt;/legend&gt;
      &lt;label&gt;Nombre del carrito:
        &lt;input type=&quot;text&quot; name=&quot;nombre&quot; required&gt;
      &lt;/label&gt;
      &lt;button&gt;Usa&lt;/button&gt;
    &lt;/fieldset&gt;
  &lt;/form&gt;
  &lt;form id=&quot;f1&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Crear un nuevo carrito&lt;/legend&gt;
      &lt;button&gt;Crea&lt;/button&gt;
    &lt;/fieldset&gt;
  &lt;/form&gt;
  &lt;form id=&quot;f2&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Añadir item al carrito&lt;/legend&gt;
      &lt;label&gt;Nombre del item:
          &lt;input type=&quot;text&quot; name=&quot;item&quot; required&gt;
      &lt;/label&gt; 
      &lt;label&gt;Cantidad:
          &lt;input type=&quot;text&quot; name=&quot;cantidad&quot; required pattern=&quot;[0-9]+&quot;&gt;
      &lt;/label&gt; 
      &lt;button&gt;Añade&lt;/button&gt;
    &lt;/fieldset&gt;
  &lt;/form&gt;
  &lt;form id=&quot;f3&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Actualizar cantidad de un item&lt;/legend&gt;
      &lt;label&gt;Nombre del item:
          &lt;input type=&quot;text&quot; name=&quot;item&quot; required&gt;
      &lt;/label&gt; 
      &lt;label&gt;Nueva cantidad:
          &lt;input type=&quot;text&quot; name=&quot;cantidad&quot; required pattern=&quot;[0-9]+&quot;&gt;
      &lt;/label&gt; 
      &lt;button&gt;Actualiza&lt;/button&gt;
    &lt;/fieldset&gt;
  &lt;/form&gt;
  &lt;form id=&quot;f4&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Borrar un item del carrito&lt;/legend&gt;
      &lt;label&gt;Nombre del item:
          &lt;input type=&quot;text&quot; name=&quot;item&quot; required&gt;
      &lt;/label&gt;
      &lt;button&gt;Borra&lt;/button&gt; 
    &lt;/fieldset&gt;
  &lt;/form&gt;
  &lt;form id=&quot;f5&quot;&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Eliminar el carrito actual&lt;/legend&gt;
      &lt;button&gt;Elimina&lt;/button&gt;
    &lt;/fieldset&gt;
  &lt;/form&gt;
  
  &lt;main&gt;
    &lt;div&gt;Nombre del carrito actual: &lt;span id=&quot;nombre&quot;&gt;&lt;/span&gt;&lt;/div&gt;
    &lt;div&gt;Última respuesta del servidor: &lt;span id=&quot;mensaje&quot;&gt;&lt;/span&gt;&lt;/div&gt;
    &lt;div&gt;Contenido del carrito:&lt;/div&gt;
    &lt;table&gt;
      &lt;thead&gt;
        &lt;th&gt;Item&lt;/th&gt;
        &lt;th&gt;Cantidad&lt;/th&gt;
      &lt;/thead&gt;
      &lt;tbody id=&quot;listado&quot;&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/main&gt;

&lt;script&gt;
  // Endpoint de la API del carrito:
  const base=&quot;/carrito/v1&quot;;
  
  var carrito= &quot;&quot;;
  const cabeceras= {
    &#39;Content-Type&#39;: &#39;application/json&#39;,
    &#39;Accept&#39;: &#39;application/json&#39;,
  }

  function print(r) {
    const e= document.querySelector(&#39;#mensaje&#39;);  
    if(r.result) {
      e.textContent= JSON.stringify(r.result);
    }
    else {
      e.textContent= JSON.stringify(r.error);
    }
  }

  function printError(s) {
    const e= document.querySelector(&#39;#mensaje&#39;);  
    e.textContent= `Problema de conexión: ${s}`;
  }

  
  function usaCarrito (event) {
    event.preventDefault(); // evita la recarga de la página
    const e= document.querySelector(&quot;#f0 input[name=&#39;nombre&#39;]&quot;);
    document.querySelector(&#39;#nombre&#39;).textContent= carrito= e.value;
    e.value= &quot;&quot;;
    muestraCarrito();
  }


  function creaCarrito(event) {
    event.preventDefault();
    const url= `${base}/creacarrito`;
    const payload= {};
    const request = {
      method: &#39;POST&#39;, 
      headers: cabeceras,
      body: JSON.stringify(payload),
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r =&gt; {
      carrito= r.result.nombre;
      document.querySelector(&quot;#nombre&quot;).textContent= carrito;
      muestraCarrito();
      print(r);
    })
    .catch( error =&gt; printError(error) );
  }


  function muestraCarrito() {
    const url= `${base}/${carrito}/productos`;
    const request = {
      method: &#39;GET&#39;, 
      headers: cabeceras,
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r =&gt; {
      const e= document.querySelector(&#39;#listado&#39;);
      e.innerHTML= &#39;&#39;;
      if (r.result) {
        for(var i=0;i&lt;r.result.length;i++) {
          e.innerHTML+= `&lt;tr&gt;
            &lt;td&gt;${r.result[i].item}&lt;/td&gt;
            &lt;td&gt;${r.result[i].cantidad}&lt;/td&gt;
            &lt;/tr&gt;`;
        }
      }
    })
    .catch( error =&gt; printError(error) );
  }
   
  
  function nuevoItem (event) {
    event.preventDefault();
    const url= `${base}/${carrito}/productos`;
    const payload= {
      item:document.querySelector(&quot;#f2 input[name=&#39;item&#39;]&quot;).value,
      cantidad:document.querySelector(&quot;#f2 input[name=&#39;cantidad&#39;]&quot;).value,
    };
    const request = {
      method: &#39;POST&#39;, 
      headers: cabeceras,
      body: JSON.stringify(payload),
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r =&gt; {
      print(r);
      document.querySelector(&quot;#f2 input[name=&#39;item&#39;]&quot;).value= &#39;&#39;;
      document.querySelector(&quot;#f2 input[name=&#39;cantidad&#39;]&quot;).value= &#39;&#39;;
      muestraCarrito();
    })
    .catch( error =&gt; printError(error) );
  }
  
  
  function actualizaItem (event) {
    event.preventDefault();
    const item= document.querySelector(&quot;#f3 input[name=&#39;item&#39;]&quot;).value;
    const url= `${base}/${carrito}/productos/${item}`;
    const payload= {
      cantidad:document.querySelector(&quot;#f3 input[name=&#39;cantidad&#39;]&quot;).value,
    }; 
    const request = {
      method: &#39;PUT&#39;, 
      headers: cabeceras,
      body: JSON.stringify(payload),
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r =&gt; {
      print(r);
      document.querySelector(&quot;#f3 input[name=&#39;item&#39;]&quot;).value= &#39;&#39;;
      document.querySelector(&quot;#f3 input[name=&#39;cantidad&#39;]&quot;).value= &#39;&#39;;
      muestraCarrito();
    })
    .catch( error =&gt; printError(error) );
  }
  

  function borraItem (event) {
    event.preventDefault();
    const item= document.querySelector(&quot;#f4 input[name=&#39;item&#39;]&quot;).value;
    const url= `${base}/${carrito}/productos/${item}`;
    const payload= {}; 
    var request = {
      method: &#39;DELETE&#39;, 
      headers: cabeceras,
      body: JSON.stringify(payload),
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r =&gt; {
      print(r);
      document.querySelector(&quot;#f4 input[name=&#39;item&#39;]&quot;).value= &#39;&#39;;
      muestraCarrito();
    })
    .catch( error =&gt; printError(error) );
  }
  

  function eliminaCarrito (event) {
    event.preventDefault();
    const url= `${base}/${carrito}`;
    const payload= {};
    var request = {
      method: &#39;DELETE&#39;, 
      headers: cabeceras,
      body: JSON.stringify(payload),
    };
    fetch(url,request)
    .then( response =&gt; response.json() )
    .then( r  =&gt; {
      print(r); 
      muestraCarrito();
    })
    .catch( error =&gt; printError(error) );
  }


  // Función de inicialización:
  function init () {
    let e= document.querySelector(&#39;#f0&#39;);
    e.addEventListener(&#39;submit&#39;,usaCarrito,false); 
    e= document.querySelector(&#39;#f1&#39;);
    e.addEventListener(&#39;submit&#39;,creaCarrito,false);
    e= document.querySelector(&#39;#f2&#39;);
    e.addEventListener(&#39;submit&#39;,nuevoItem,false);
    e= document.querySelector(&#39;#f3&#39;);
    e.addEventListener(&#39;submit&#39;,actualizaItem,false);
    e= document.querySelector(&#39;#f4&#39;);
    e.addEventListener(&#39;submit&#39;,borraItem,false);
    e= document.querySelector(&#39;#f5&#39;);
    e.addEventListener(&#39;submit&#39;,eliminaCarrito,false);
  }
    
  document.addEventListener(&#39;DOMContentLoaded&#39;,init,false);
&lt;/script&gt;

&lt;/body&gt;

&lt;/html&gt;
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="peticiones-cors">
<h3>4.7.2. Peticiones CORS<a class="headerlink" href="#peticiones-cors" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>La API REST del carrito soporta peticiones Fetch realizadas desde programas en JavaScript descargados de dominios diferentes al dominio en el que está ubicada la API. Para comprobarlo, abre el fichero <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> desde un servidor web local; recuerda cambiar antes la variable <code class="docutils literal notranslate"><span class="pre">base</span></code> de JavaScript para que apunte al <em>endpoint</em> de la API que has usado en la actividad anterior.</p>
</div>
<p>Si tienes Python 2 instalado, ejecuta desde el directorio donde está <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> una de las dos siguientes órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHttpServer</span>
<span class="n">python2</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHttpServer</span>
</pre></div>
</div>
<p>Si tienes Python 3 instalado en tu sistema, ejecuta desde el directorio donde está <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> una de las dos siguientes órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>
</pre></div>
</div>
<p>El servidor te informará del puerto en <code class="docutils literal notranslate"><span class="pre">localhost</span></code> desde el que puedes acceder al contenido del directorio. Realiza peticiones desde la aplicación web del carrito y analiza las cabeceras relacionadas con CORS de la petición y la respuesta. Observa cómo las peticiones de tipo POST, PUT o DELETE realizan una comprobación <em>pre-vuelo</em> con el verbo OPTIONS. Modifica el cliente para que envíe una cabecera adicional no convencional y observa cómo la respuesta del servidor hace que la petición falle al no devolver el servidor el nombre de la cabecera en la lista devuelta en <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Headers</span></code>.</p>
</div>
</div>
<div class="section" id="programacion-de-servicios-web-en-node-js">
<h2>4.8. Programación de servicios web en Node.js<a class="headerlink" href="#programacion-de-servicios-web-en-node-js" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los servicios web se pueden programar en prácticamente cualquier lenguaje de programación existente hoy día. Para el servicio web anterior, hemos usado JavaScript con Node.js y el <em>framework</em> para desarrollo de aplicaciones web Express. Este es el código de la parte del servidor:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309</pre></div></td><td class="code"><div class="highlight"><pre>&#39;use strict&#39;;

const express = require(&#39;express&#39;);
const app = express();

const config = require(&#39;./config.js&#39;);

var knex= null;

// inicializa Knex.js para usar diferentes bases de datos según el entorno:
function conectaBD () {
  if (knex===null) {
    var options;
    if (process.env.CARRITO_ENV === &#39;gae&#39;) {
      options= config.gae;
      console.log(&#39;Usando Cloud SQL (MySQL) como base de datos en Google App Engine&#39;);
    } else if (process.env.CARRITO_ENV === &#39;heroku&#39;) {
      options= config.heroku;
      console.log(&#39;Usando PostgreSQL como base de datos en Heroku&#39;);
    } else {
      options= config.localbd;
      console.log(&#39;Usando SQLite como base de datos local&#39;);
    }
    // Muestra la conversión a SQL de cada consulta:
    // options.debug= true;
    knex= require(&#39;knex&#39;)(options);
  }
}

// crea las tablas si no existen:
async function creaEsquema(res) {
  try {
    let existeTabla= await knex.schema.hasTable(&#39;carritos&#39;);
    if (!existeTabla) {
      await knex.schema.createTable(&#39;carritos&#39;, (tabla) =&gt; {
        tabla.increments(&#39;carritoId&#39;).primary();
        tabla.string(&#39;nombre&#39;, 100).notNullable();
      });
      console.log(&quot;Se ha creado la tabla carritos&quot;);
    }
    existeTabla= await knex.schema.hasTable(&#39;productos&#39;);
    if (!existeTabla) {
      await knex.schema.createTable(&#39;productos&#39;, (table) =&gt; {
        table.increments(&#39;productoId&#39;).primary();
        table.string(&#39;carrito&#39;, 100).notNullable();
        table.string(&#39;item&#39;, 100).notNullable();
        table.integer(&#39;cantidad&#39;).unsigned().notNullable();
      });
      console.log(&quot;Se ha creado la tabla productos&quot;);
    }
  }
  catch (error) {
    console.log(`Error al crear las tablas: ${error}`);
    res.status(404).send({ result:null,error:&#39;error al crear la tabla; contacta con el administrador&#39; });
  }
}

async function numeroCarritos() {
  return await knex(&#39;carritos&#39;).countDistinct(&#39;nombre&#39;);
}

async function numeroItems(carrito) {
  let r= await knex(&#39;productos&#39;).select(&#39;item&#39;)
                                .where(&#39;carrito&#39;,carrito);
  return r.length;
}

async function existeCarrito(carrito) {
  let r= await knex(&#39;carritos&#39;).select(&#39;nombre&#39;)
                               .where(&#39;nombre&#39;,carrito);
  return r.length&gt;0;
}

async function existeItem(item,carrito) {
  let r= await knex(&#39;productos&#39;).select(&#39;item&#39;)
                                .where(&#39;item&#39;,item)
                                .andWhere(&#39;carrito&#39;,carrito);
  return r.length&gt;0;
}


// asume que el cuerpo del mensaje de la petición está en JSON:
app.use(express.json());

// middleware para aceptar caracteres UTF-8 en la URL:
app.use( (req, res, next) =&gt; {
  req.url = decodeURI(req.url);
  next();
});

// middleware para las cabeceras de CORS:
app.use( (req, res, next) =&gt; {
  res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
  res.header(&#39;Access-Control-Allow-Methods&#39;, &#39;DELETE, PUT, GET, POST, OPTIONS&#39;);
  res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;content-type&quot;);
  next();
});


// middleware que establece la conexión con la base de datos y crea las 
// tablas si no existen; en una aplicación más compleja se crearía el
// esquema fuera del código del servidor:
app.use( async (req, res, next) =&gt; {
  app.locals.knex= conectaBD(app.locals.knex);
  await creaEsquema(res);
  next();
});


// crea un carrito:
app.post(config.app.base+&#39;/creacarrito&#39;, async (req,res) =&gt; {
  try {
    let n= await numeroCarritos();
    if (n&gt;=config.app.maxCarritos) {
      res.status(404).send({ result:null,error:&#39;No caben más carritos; contacta con el administrador&#39; });
      return;
    }
    let existe= true;
    while (existe) {
      var nuevo = Math.random().toString(36).substring(7);
      existe= await existeCarrito(nuevo);
    }
    var c= { nombre:nuevo };
    await knex(&#39;carritos&#39;).insert(c);
    res.status(200).send({ result:{ nombre:nuevo },error:null });
  } catch (error) {
    console.log(`No se puede crear el carrito: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo crear el carrito&#39; });
  }
});


// crea un nuevo item:
app.post(config.app.base+&#39;/:carrito/productos&#39;, async (req, res) =&gt; {
  if (!req.body.item || !req.body.cantidad) {
    res.status(404).send({ result:null,error:&#39;datos mal formados&#39; });
    return;
  }
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    existe= await existeItem(req.body.item,req.params.carrito);
    if (existe) {
      res.status(404).send({ result:null,error:`item ${req.body.item} ya existente` });
      return;
    }
    let n= await numeroItems(req.params.carrito);
    if (n&gt;=config.app.maxProductos) {
      res.status(404).send({ result:null,error:`No caben más productos en el carrito ${req.params.carrito}` });
      return;
    }
    var i= { carrito:req.params.carrito,item:req.body.item,cantidad:req.body.cantidad };
    await knex(&#39;productos&#39;).insert(i);
    res.status(200).send({ result:&#39;ok&#39;,error:null });
  } catch (error) {
    console.log(`No se puede añadir el item: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo añadir el item&#39; });
  }
});


// lista los items de un carrito:
app.get(config.app.base+&#39;/:carrito/productos&#39;, async (req, res) =&gt; {
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    let i= await knex(&#39;productos&#39;).select([&#39;item&#39;,&#39;cantidad&#39;])
                                  .where(&#39;carrito&#39;,req.params.carrito);
    res.status(200).send({ result:i,error:null });
  } catch (error) {
    console.log(`No se puede obtener los productos del carrito: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo obtener los datos del carrito&#39; });
  }
});


// lista los datos de un item:
app.get(config.app.base+&#39;/:carrito/productos/:item&#39;, async (req, res) =&gt; {
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    existe= await existeItem(req.params.item,req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`item ${req.params.item} no existente` });
      return;
    }
    let i= await knex(&#39;productos&#39;).select([&#39;item&#39;,&#39;cantidad&#39;])
                                  .where(&#39;carrito&#39;,req.params.carrito)
                                  .andWhere(&#39;item&#39;,req.params.item);
    res.status(200).send({ result:i[0],error:null });
  } catch (error) {
    console.log(`No se pudo obtener el item: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo obtener el item&#39; });
  }
});


// modifica un item:
app.put(config.app.base+&#39;/:carrito/productos/:item&#39;, async (req, res) =&gt; {
  if (!req.body.cantidad) {
    res.status(404).send({ result:null,error:&#39;datos mal formados&#39; });
    return;
  }
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    existe= await existeItem(req.params.item,req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`item ${req.params.item} no existente` });
      return;
    }
    await knex(&#39;productos&#39;).update(&#39;cantidad&#39;,req.body.cantidad)
                           .where(&#39;carrito&#39;,req.params.carrito)
                           .andWhere(&#39;item&#39;,req.params.item);
    res.status(200).send({ result:&#39;ok&#39;,error:null });
  } catch (error) {
    console.log(`No se pudo obtener el item: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo obtener el item&#39; });
  }
});


// borra un item:
app.delete(config.app.base+&#39;/:carrito/productos/:item&#39;, async (req, res) =&gt; {
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    existe= await existeItem(req.params.item,req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`item ${req.paramsº.item} no existente` });
      return;
    }
    await knex(&#39;productos&#39;).where(&#39;carrito&#39;,req.params.carrito).andWhere(&#39;item&#39;,req.params.item).del();
    res.status(200).send({ result:&#39;ok&#39;,error:null });
  } catch (error) {
    console.log(`No se pudo obtener el item: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo obtener el item&#39; });
  }
});


// borra un carrito:
app.delete(config.app.base+&#39;/:carrito&#39;, async (req, res) =&gt; {
  try {
    let existe= await existeCarrito(req.params.carrito);
    if (!existe) {
      res.status(404).send({ result:null,error:`carrito ${req.params.carrito} no existente` });
      return;  
    }
    await knex(&#39;productos&#39;).where(&#39;carrito&#39;,req.params.carrito)
                           .del();
    await knex(&#39;carritos&#39;).where(&#39;nombre&#39;,req.params.carrito)
                          .del();
    res.status(200).send({ result:&#39;ok&#39;,error:null });
  } catch (error) {
    console.log(`No se pudo encontrar el carrito: ${error}`);
    res.status(404).send({ result:null,error:&#39;no se pudo encontrar el carrito&#39; });
  }
});


const secret= &#39;12345&#39;;

// borra toda la base de datos:
app.get(config.app.base+&#39;/clear&#39;, async (req,res) =&gt; {
  try {
    await knex(&#39;productos&#39;).where(&#39;carrito&#39;,req.params.carrito)
                           .del();
    await knex(&#39;carrito&#39;).where(&#39;nombre&#39;,req.params.carrito)
                         .del();
    res.status(200).send({ result:&#39;ok&#39;,error:null });
  } catch (error) {
    console.log(`No se pudo borrar la base de datos: ${error}`);
  }
});


const path = require(&#39;path&#39;);
const publico = path.join(__dirname, &#39;public&#39;);
// __dirname: carpeta del proyecto

app.get(config.app.base+&#39;/&#39;, (req, res) =&gt; {
  res.status(200).send(&#39;API web para gestionar carritos de la compra&#39;);
});

app.get(config.app.base+&#39;/ayuda&#39;, (req, res) =&gt; res.sendFile(path.join(publico, &#39;index.html&#39;))
);

app.use(&#39;/&#39;, express.static(publico));

const PORT = process.env.PORT || 5000;
app.listen(PORT, function () {
  console.log(`Aplicación lanzada en el puerto ${ PORT }!`);
});
</pre></div>
</td></tr></table></div>
<p>Express es un <em>módulo</em> de Node.js. La función de Node.js <code class="docutils literal notranslate"><span class="pre">require</span></code> carga un módulo (de forma similar a los <em>import</em> o <em>include</em> de otros lenguajes) y devuelve un objeto que representa los elementos que exporte el módulo. En este caso, Express exporta una función de inicialización que permite usar el resto de funciones. El código de Express contendrá unas líneas similares a estas:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">createApplication</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">createApplication</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">app</span><span class="o">=</span> <span class="p">...</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>El código registra (llamando a <code class="docutils literal notranslate"><span class="pre">app.use</span></code>) varias funciones de <em>middleware</em>, que son invocadas para todas las peticiones y que se encargan de diversos aspectos: indicar que el bloque de datos de la petición contendrá información en JSON, descodificar los caracteres que usen la notación <em>por ciento</em> (véase una actividad anterior en este tema), devolver las cabeceras necesarias para permitir peticiones CORS (como también hemos visto) o establecer la conexión con el gestor de base de datos. Todas estas funciones de <em>middleware</em> son llamadas por Express con tres parámetros: un objeto que representa la solicitud (<code class="docutils literal notranslate"><span class="pre">req</span></code> en el código), un objeto que representa la respuesta que se devolverá al cliente (<code class="docutils literal notranslate"><span class="pre">res</span></code> en el código) y un objeto que representa la siguiente función de <em>middleware</em> (<code class="docutils literal notranslate"><span class="pre">next</span></code> en el código); cada función de <em>middleware</em> ha de llamar a la siguiente función de <em>middleware</em>, excepto cuando se detecta algún error y se desea enviar inmediatamente una respuesta al cliente con la función <code class="docutils literal notranslate"><span class="pre">res.send</span></code> (como ocurre en la función <code class="docutils literal notranslate"><span class="pre">creaEsquema</span></code>).</p>
<p>Express añade automáticamente algunas cabeceras a la respuesta. Por ejemplo, si usamos un objeto de JavaScript como argumento de la llamada a <code class="docutils literal notranslate"><span class="pre">send</span></code>, los datos se convierten a JSON y la cabecera <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> se establece a <code class="docutils literal notranslate"><span class="pre">application/json;</span> <span class="pre">charset=utf-8</span></code>.</p>
<p>El código principal de la aplicación está formado por una serie de llamadas a funciones <code class="docutils literal notranslate"><span class="pre">get</span></code>, <code class="docutils literal notranslate"><span class="pre">post</span></code>, <code class="docutils literal notranslate"><span class="pre">put</span></code> y <code class="docutils literal notranslate"><span class="pre">delete</span></code> que registran las funciones de callback asociadas a las peticiones realizadas con los verbos y los URLs correspondientes. Observa cómo una subcadena del URL que comienza por el carácter de dos puntos (por ejemplo, <code class="docutils literal notranslate"><span class="pre">:item</span></code>) no se interpreta literalmente, sino que la subcadena real puesta en el URL de la llamada se usa para dar valor al atributo del objeto <code class="docutils literal notranslate"><span class="pre">req.params</span></code> ( en ese caso, <code class="docutils literal notranslate"><span class="pre">req.params.item</span></code>). A los atributos de los datos en JSON del bloque de datos de la petición nos podemos referir mediante el objeto <code class="docutils literal notranslate"><span class="pre">req.body</span></code>. A los atributos pasados en el propio URL tras el carácter de interrogación se puede acceder mediante el objeto <code class="docutils literal notranslate"><span class="pre">req.query</span></code>.</p>
<div class="section" id="interfaz-comun-de-acceso-a-bases-de-datos">
<h3>4.8.1. Interfaz común de acceso a bases de datos<a class="headerlink" href="#interfaz-comun-de-acceso-a-bases-de-datos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Como queremos que nuestra aplicación web pueda funcionar con distintos gestores de bases de datos (Heroku permite usar PostgreSQL, Google Cloud Platform permite usar MySQL y en modo local vamos a usar una base de datos <em>ligera</em> con SQLite para hacer pruebas), nos interesa no tener que escribir código diferente para cada uno. Node.js no tiene un equivalente exacto a, por ejemplo, la tecnología JDBC de Java, pero el paquete Knex.js (pronunciado como <em>konnex</em>) se acerca bastante al permitirnos interactuar con diferentes gestores de bases de datos con una interfaz única. Con Knex.js usaremos funciones para construir las consultas a la base de datos que serán transformadas internamente en instrucciones SQL; las peticiones a la base de datos son asíncronas y se gestionan mediante promesas o mediante <em>callbacks</em>. Las funciones que a este respecto se usan en el código son bastante autoexplicativas y es muy sencillo deducir cuál es su transformación en SQL. Por ejemplo, las líneas de código:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">([</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cantidad&#39;</span><span class="p">])</span>
                              <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                              <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
</pre></div>
</div>
<p>generan una petición SQL como la siguiente:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>select `item`, `cantidad` from `productos` where `carrito` = ? and `item` = ?
</pre></div>
</div>
</div>
<div class="section" id="async-await">
<h3>4.8.2. Async/await<a class="headerlink" href="#async-await" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Las promesas de la API Fetch son, como hemos visto, una forma muy conveniente de gestionar peticiones a un servidor, pero cuando la llamada a un servicio web depende del resultado de una llamada anterior a otro servicio web y este anidamiento se va haciendo más y más complejo, la escritura del código puede ser muy dificultosa (especialmente a la hora de sangrarlo o de emparejar las llaves y los paréntesis). Para simplificarlo, se añadieron a JavaScript los modificadores <code class="docutils literal notranslate"><span class="pre">async</span></code> y <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
<p>Cuando se invoca una función anotada con <code class="docutils literal notranslate"><span class="pre">async</span></code>, la respuesta a la llamada se procesa como si fuera una promesa. Si la función <code class="docutils literal notranslate"><span class="pre">async</span></code> devuelve un valor, dicha promesa se resolverá con el valor devuelto: si la función asíncrona generara una excepción, la promesa se rechazaría con el valor devuelto. Dentro de una función asíncrona puede aparecer cualquier número de expresiones <code class="docutils literal notranslate"><span class="pre">await</span></code> (estas expresiones, de hecho, solo pueden aparecer dentro de funciones <code class="docutils literal notranslate"><span class="pre">async</span></code>); una expresión <code class="docutils literal notranslate"><span class="pre">await</span></code> pausa la ejecución de la función asíncrona y espera a que la promesa se resuelva para continuar la ejecución de la función asíncrona.</p>
<p>El código de más arriba que accedía con Fetch a la API de películas del Studio Ghibli quedaría de la siguiente manera con  <code class="docutils literal notranslate"><span class="pre">async</span></code> y <code class="docutils literal notranslate"><span class="pre">await</span></code>:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">async</span> <span class="kd">function</span> <span class="nx">ghibli</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">s</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">response</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://ghibliapi.herokuapp.com/films/&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">responseAsObject</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">responseAsObject</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="o">+=</span> <span class="nx">responseAsObject</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Ha habido un problema: &#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">print</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">resultado</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#results&quot;</span><span class="p">);</span>
  <span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">ghibli</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">print</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web">
<span id="label-local"></span><h2>4.9. Configuración del entorno de trabajo para ejecutar localmente una aplicación web<a class="headerlink" href="#configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta actividad se explica cómo configurar el entorno de trabajo para poder lanzar aplicaciones web escritas en Node.js que usan una base de datos SQLite3.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>El sistema operativo <em>oficial</em> en esta asignatura es Linux. Puedes utilizar otros sistemas operativos para desarrollar, pero tendrás que solucionar tú mismo los problemas relacionados con la configuración del entorno de trabajo que te encuentres. Las instrucciones que siguen son para el sistema operativo Linux, pero es muy probable que las puedas ignorar si usas el fichero <a class="reference external" href="_static/data/dai-bundle-dev-20191128.tar.gz">dai-bundle-dev</a> para instalar los programas necesarios. Para ello, descarga el fichero, descomprímelo y ejecuta el script <code class="docutils literal notranslate"><span class="pre">install.sh</span></code>.</p>
<p>Puedes editar el fichero para indicar qué programas quieres instalar. El script solo instala Node.js por defecto. Comprueba si tienes instalado <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> en tu ordenador para saber si lo necesitas y pon a <code class="docutils literal notranslate"><span class="pre">true</span></code> la variable correspondiente en caso negativo. El script también permite instalar el SDK de Google Cloud Platform, que usaremos más adelante.</p>
<p>El script funciona sin problemas en el sistema Linux instalado en los ordenadores de los laboratorios, donde SQLite3 ya está instalado.</p>
</div>
<p>Comienza instalando <a class="reference external" href="https://nodejs.org/">Node.js</a>, el entorno que te permitirá ejecutar programas en JavaScript fuera del navegador. Las instrucciones para cada sistema operativo son diferentes. Para el caso de Linux, la instalación se puede realizar fácilmente sin necesidad de tener privilegios de administrador descargando uno de los <a class="reference external" href="https://nodejs.org/en/download/releases/">paquetes disponibles</a> en la web de Node.js.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si tu distribución de Linux tiene ya instalada una versión muy antigua de Node.js es recomendable que la quites antes de tu sistema con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">nodejs</span>
</pre></div>
</div>
</div>
<p>Este curso vamos a usar la versión 12 de Node.js. Descárgala con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nodejs</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">v12</span><span class="o">.</span><span class="mf">13.1</span><span class="o">/</span><span class="n">node</span><span class="o">-</span><span class="n">v12</span><span class="o">.</span><span class="mf">13.1</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>Descomprime el fichero anterior en tu directorio raíz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>tar xzf node-v12.13.1-linux-x64.tar.gz -C $HOME
</pre></div>
</div>
<p>Añade el directorio <code class="docutils literal notranslate"><span class="pre">bin</span></code> a la variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> del sistema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>echo &#39;export PATH=$HOME/node-v12.13.1-linux-x64/bin:$PATH&#39; &gt;&gt; $HOME/.bashrc
</pre></div>
</div>
<p>Abre un nuevo terminal para que el nuevo valor de la variable de entorno <code class="docutils literal notranslate"><span class="pre">PATH</span></code> se aplique. Ahora deberías poder ver la versión de Node.js instalada con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">node</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
<p>La aplicación del carrito usa en modo local el gestor de base de datos <em>ligero</em> <a class="reference external" href="https://www.sqlite.org/index.html">SQLite3</a> para no depender de gestores más complejos. Cuando la aplicación se despliegue en la nube (un poco más adelante lo haremos en Heroku y, posteriormente, en Google Cloud Platform), usará otros gestores de bases de datos, lo que explica las diferentes opciones dentro de la función <code class="docutils literal notranslate"><span class="pre">conectaBD</span></code>. Comprueba si ya tienes SQLite instalado ejecutando <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> desde la línea de órdenes. Si no lo tienes, para el caso de Linux puedes descargar este fichero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="mi">2019</span><span class="o">/</span><span class="n">sqlite</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">3300100.</span><span class="n">zip</span>
</pre></div>
</div>
<p>Descomprime el fichero anterior en tu directorio raíz y añade el nuevo directorio a la variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> del sistema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>unzip -q sqlite-tools-linux-x86-3300100.zip -d $HOME
echo &#39;export PATH=$HOME/sqlite-tools-linux-x86-3300100:$PATH&#39; &gt;&gt; $HOME/.bashrc
</pre></div>
</div>
<p>Abre un nuevo terminal para que el nuevo valor de la variable de entorno <code class="docutils literal notranslate"><span class="pre">PATH</span></code> se aplique.</p>
<p>Los binarios de SQLite están compilados para 32 bits, por lo que es posible que necesites instalar algunas librerías adicionales de 32 bits, ya que tu sistema es proablemente de 64 bits; la siguiente orden es para Ubuntu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libc6</span><span class="o">-</span><span class="n">i386</span> <span class="n">lib32z1</span>
</pre></div>
</div>
<p>Ahora deberías poder ver la versión de SQLite3 instalada con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">sqlite3</span> <span class="o">-</span><span class="n">version</span>
</pre></div>
</div>
<p>A continuación, descarga el código del cliente y del servidor de la aplicación del carrito; clona para ello el <a class="reference external" href="https://github.com/jaspock/dai1920">repositorio de la asignatura</a> haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jaspock</span><span class="o">/</span><span class="n">dai1920</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Entra en el directorio <code class="docutils literal notranslate"><span class="pre">code/carrito</span></code> y ejecuta:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">npm</span> <span class="n">install</span>
<span class="n">node</span> <span class="n">app</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
<p>La primera línea instala en la carpeta <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> todas las dependencias indicadas en el fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>. La segunda línea lanza el motor de JavaScript sobre el fichero indicado. Como este fichero contiene una aplicación web escrita con el framework Express, este la ejecuta sobre un puerto local, por lo que podremos acceder a ella abriendo en el navegador una dirección como <code class="docutils literal notranslate"><span class="pre">localhost:5000</span></code> o similar.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si quisieras usar un nuevo paquete en tu aplicación (lo que probablemente no ocurrirá en esta asignatura), deberías ejecutar:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">npm</span> <span class="n">install</span> <span class="n">paquete</span>
</pre></div>
</div>
<p>donde <code class="docutils literal notranslate"><span class="pre">paquete</span></code> es el nombre del nuevo módulo; esta orden instala el nuevo módulo en la carpeta <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> y, además, añade la línea adecuada al fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Observa la sección <code class="docutils literal notranslate"><span class="pre">scripts</span></code> del fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>. Allí puedes definir diversas maneras de arrancar tu aplicación con diferentes configuraciones. En este caso, solo hay una entrada <code class="docutils literal notranslate"><span class="pre">start</span></code> que te permitiría lanzar también tu aplicación haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">npm</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="depuracion-y-prueba-de-la-aplicacion">
<h3>4.9.1. Depuración y prueba de la aplicación<a class="headerlink" href="#depuracion-y-prueba-de-la-aplicacion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Si deseas depurar el código del servidor en modo local puedes usar el editor de texto <a class="reference external" href="https://code.visualstudio.com/">Visual Studio Code</a>. Abre con él el fichero <code class="docutils literal notranslate"><span class="pre">app.js</span></code> y selecciona <span class="guilabel">Debug / Start debugging</span>. Puedes definir puntos de ruptura haciendo click en el borde de la línea de código oportuna.</p>
<blockquote>
<div></div></blockquote>
<p>Para depurar la aplicación cuando esta se encuentra desplegada en la nube, se necesitan algunas instrucciones adicionales. En el caso de nuestra aplicación, como el código que se ejecuta en <code class="docutils literal notranslate"><span class="pre">localhost</span></code> o en la nube es prácticamente el mismo, si la aplicación funciona en local, apenas deberían aparecer problemas en la nube.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Ten en cuenta que el código de JavaScript que se ejecuta en el navegador se seguirá depurando desde las Chrome DevTools. Durante la depuración de la aplicación irás alternando entre el navegador y Visual Studio Code según se esté ejecutando el código del lado del cliente o del servidor, respectivamente.</p>
</div>
<p>Al ejecutar la aplicación en modo local se usa el gestor de base de datos SQLite, que almacena la base de datos en un fichero indicado como opción de inicialización a Knex.js (en nuestra aplicación el fichero se indica en <code class="docutils literal notranslate"><span class="pre">config.js</span></code>). Si quieres borrar toda la base de datos para empezar de cero, basta con que borres ese fichero, que será creado de nuevo la siguiente vez que Knex.js quiera acceder a él.</p>
<p>Si quieres, realizar consultas a la base de datos local desde un cliente de SQL puedes hacer desde la línea de órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">sqlite3</span> <span class="o">&lt;</span><span class="n">ficheroBD</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>donde has de indicar como argumento el nombre del fichero de la base de datos (si no has editado los ficheros de configuración del carrito se llamará <code class="docutils literal notranslate"><span class="pre">midb.sqlite</span></code>). Desde dentro del cliente puedes ejecutar instrucciones como:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="o">.</span><span class="n">tables</span>
</pre></div>
</div>
<p>para ver las tablas de la base de datos o:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">productos</span><span class="p">;</span>
</pre></div>
</div>
<p>para consultarlas.</p>
</div>
</div>
<div class="section" id="modificacion-de-la-api-rest">
<h2>4.10. Modificación de la API REST<a class="headerlink" href="#modificacion-de-la-api-rest" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta actividad, vas a realizar una pequeña modificación a la API del carrito y a la aplicación web que la utiliza. El desarrollo lo realizarás en tu máquina y, cuando hayas comprobado que todo funciona correctamente, lo subirás en la siguiente actividad a un servidor de aplicaciones en la nube.</p>
<div class="admonition hint">
<p class="admonition-title">Consejo</p>
<p>Si vas a desarrollar frecuentemente con Node.js, te vendrá bien utilizar la herramienta <a class="reference external" href="https://www.npmjs.com/package/nodemon">nodemon</a>, que evita que tengas que matar y volver a lanzar el servidor local cada vez que hagas un cambio en la aplicación.</p>
</div>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Modifica la parte del cliente y del servidor de la aplicación del carrito para que junto con la cantidad se pueda añadir el precio unitario de cada item. Necesitarás instalar en tu sistema Node.js y el gestor de base de datos SQLite3; sigue para ello los pasos detallados en la actividad «<a class="reference internal" href="#label-local"><span class="std std-ref">Configuración del entorno de trabajo para ejecutar localmente una aplicación web</span></a>». Salvo que uses <code class="docutils literal notranslate"><span class="pre">nodemon</span></code>, como se ha comentado antes, tendrás que matar y relanzar el servidor para que se apliquen los cambios. Como siempre, tendrás que recargar la página en el navegador siempre que realices algún cambio en el código del cliente.</p>
</div>
</div>
<div class="section" id="despliegue-de-la-aplicacion-web-en-heroku">
<span id="label-heroku"></span><h2>4.11. Despliegue de la aplicación web en Heroku<a class="headerlink" href="#despliegue-de-la-aplicacion-web-en-heroku" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Cuando tengas la aplicación lista en modo local, puedes desplegarla en la plataforma en la nube de <a class="reference external" href="https://www.heroku.com/">Heroku</a> como sigue.
Copia para empezar la carpeta <code class="docutils literal notranslate"><span class="pre">dai1920/code/carrito</span></code> en otra ubicación de tu sistema. Al copiar la carpeta a una ubicación diferente haces que su contenido no esté ligado al repositorio de Github, ya que para desplegar la aplicación en Heroku necesitas vincularla a otro repositorio.</p>
<p>Instala el cliente de línea de órdenes (CLI, por <em>command-line interface</em>) de Heroku con las <a class="reference external" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install">instrucciones de esta página</a>. En el caso de Linux basta con hacer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">cli</span><span class="o">-</span><span class="n">assets</span><span class="o">.</span><span class="n">heroku</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">sh</span>
</pre></div>
</div>
<p>Si tienes permisos de administrador puedes instalar de forma alternativa el cliente de línea de órdenes de Heroku en Ubuntu con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">sudo</span> <span class="n">snap</span> <span class="n">install</span> <span class="o">--</span><span class="n">classic</span> <span class="n">heroku</span>
</pre></div>
</div>
<p>Continúa ahora configurando tu proyecto haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">git</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s">&quot;cambios&quot;</span>
</pre></div>
</div>
<p>Con lo anterior, se crea un repositorio con los ficheros del proyecto, que podrás subir (<em>push</em>) a Heroku. Crea una cuenta en la web de Heroku e identifícate en el cliente de línea de órdenes ejecutando:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="n">login</span>
</pre></div>
</div>
<p>Crea un proyecto en la nube haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="n">create</span> <span class="o">--</span><span class="n">region</span> <span class="n">eu</span>
</pre></div>
</div>
<p>Desde este momento ya podrás <a class="reference external" href="https://devcenter.heroku.com/articles/git">desplegar la aplicación</a> con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Heroku puede, en principio, leer del fichero <code class="docutils literal notranslate"><span class="pre">app.json</span></code> datos como el gestor de base de datos a utilizar o el valor de ciertas variables de entorno que estarán definidas en el entorno de producción, pero en el momento de escribir esto no funciona. Por ello, has de configurar estos aspectos de tu aplicación ejecutando lo siguiente desde la línea de órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="n">addons</span><span class="p">:</span><span class="n">create</span> <span class="n">heroku</span><span class="o">-</span><span class="n">postgresql</span><span class="p">:</span><span class="n">hobby</span><span class="o">-</span><span class="n">dev</span>
<span class="n">heroku</span> <span class="n">config</span><span class="p">:</span><span class="nb">set</span> <span class="n">CARRITO_ENV</span><span class="o">=</span><span class="n">heroku</span>
</pre></div>
</div>
<p>Si ejecutas <code class="docutils literal notranslate"><span class="pre">heroku</span> <span class="pre">config</span></code> podrás ver que ahora hay dos variables de entorno: <code class="docutils literal notranslate"><span class="pre">CARRITO_ENV</span></code> y <code class="docutils literal notranslate"><span class="pre">DATABASE_URL</span></code>.</p>
</div>
<p>Finalmente, abre la aplicación en el navegador con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="nb">open</span>
</pre></div>
</div>
<p>Puedes estudiar los mensajes de actividad emitidos a la consola por tu aplicación implementada en Heroku con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="n">logs</span>
</pre></div>
</div>
<p>Para verlos conforme se van produciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">heroku</span> <span class="n">logs</span> <span class="o">--</span><span class="n">tail</span>
</pre></div>
</div>
<p>Si haces cambios en la aplicación, basta con repetir estos pasos para actualizar la aplicación en Heroku:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s">&quot;cambios&quot;</span>
<span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<p>Finalmente, puedes usar el <a class="reference external" href="https://dashboard.heroku.com/">panel de control</a> de tu aplicación en Heroku para acceder a ciertas opciones adicionales de configuración. Por otro lado, en el panel de control de la <a class="reference external" href="https://data.heroku.com/">base de datos</a> PostgreSQL puedes visitar la sección <span class="guilabel">Dataclips</span> para poder ver las tablas de tu base de datos y lanzar consultas SQL sobre ellas.</p>
</div>
<div class="section" id="terminos-de-uso-de-las-apis-web">
<h2>4.12. Términos de uso de las APIs web<a class="headerlink" href="#terminos-de-uso-de-las-apis-web" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Aunque no lo estudiaremos en esta asignatura, hay que tener en cuenta que existen en la web multitud de APIs disponibles para su uso desde aplicaciones de terceros, pero estas APIs suelen tener términos de uso (mira las condiciones de la <a class="reference external" href="https://developer.twitter.com/en/developer-terms/agreement-and-policy">API de Twitter</a>, por ejemplo) que es importante leer antes de decidirse a basar una determinada aplicación en ellas.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="componentes.html" class="btn btn-neutral float-right" title="5. Componentes web" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cliente.html" class="btn btn-neutral float-left" title="3. Programar el lado del cliente" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Juan Antonio Pérez

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>